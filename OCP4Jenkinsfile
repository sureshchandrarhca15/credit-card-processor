def myRepo, gitCommit, gitBranch, shortGitCommit, previousGitCommit
def QUAY_API_TOKEN = "l7ipk8MHo09QutMyX59zth7rghi8PHDWYNIwN6PZ"
def QUAY_URL = "https://quay.apps.cluster-121b.sandbox1172.opentlc.com"
def QUAY_REPO_NAME = "quay/ccapp"
def VULNERABILITY_OUTPUT_FILE = "/tmp/image-vulnerability.txt"
def IMAGE_ID_OUTPUT_FILE = "/tmp/image_id.txt"

pipeline {
  agent { label 'maven' }
  stages
  {
	stage('Checkout') 
	{
	steps
	{
	script
	{
	try
	{
		myRepo = checkout scm
		gitCommit = myRepo.GIT_COMMIT
		gitBranch = myRepo.GIT_BRANCH
		shortGitCommit = "${gitCommit[0..10]}"
		previousGitCommit = sh(script: "git rev-parse ${gitCommit}~", returnStdout: true)
	}
	catch(Exception e)
	{
		println "ERROR => Code Checkout failed, exiting..."
		throw e
	}
	}
	}
	}
	
	stage('Vulnerability Scan') {
	agent { label 'scan' }
      steps {
        script {
          openshift.withCluster() {
			sh " QUAY_API_TOKEN=${QUAY_API_TOKEN}"
			sh " QUAY_URL=${QUAY_URL}"
			sh " QUAY_REPO_NAME=${QUAY_REPO_NAME}"
			sh " VULNERABILITY_OUTPUT_FILE=${VULNERABILITY_OUTPUT_FILE}"
			sh " IMAGE_ID_OUTPUT_FILE=${IMAGE_ID_OUTPUT_FILE}"

			sh "/vulnerability_scan.sh -e ${QUAY_API_TOKEN} -e ${QUAY_URL} -e ${QUAY_REPO_NAME} -e ${VULNERABILITY_OUTPUT_FILE} -e ${IMAGE_ID_OUTPUT_FILE}"
          }
        }
      }
    }
    

}
}
