def myRepo, gitCommit, gitBranch, shortGitCommit, previousGitCommit
pipeline {
  agent { label 'maven' }
  stages
  {
	stage('Checkout') 
	{
	steps
	{
	script
	{
	try
	{
		myRepo = checkout scm
		gitCommit = myRepo.GIT_COMMIT
		gitBranch = myRepo.GIT_BRANCH
		shortGitCommit = "${gitCommit[0..10]}"
		previousGitCommit = sh(script: "git rev-parse ${gitCommit}~", returnStdout: true)
	}
	catch(Exception e)
	{
		println "ERROR => Code Checkout failed, exiting..."
		throw e
	}
	}
	}
	}
	stage('Build')
	{
	steps
	{
	script
	{
	try
	{
		sh """
		mvn clean install -Dmaven.test.skip=true
		"""
    }
	catch (Exception e) {
		println "Failed to Maven Build - ${currentBuild.fullDisplayName}"
		throw e
	}
	}
	}
	}
	stage('Unit Test')
	{
	steps
	{
	script
	{	
	try
	{
		sh """
		mvn test -Dmaven.test.skip=true
		"""
    }
	catch (Exception e) 
	{
		println "Failed to Run Unit Test - ${currentBuild.fullDisplayName}"
		throw e
	}
	}
	}
	}
	stage('Sonar Analysis')
	{
	steps
	{
	script
	{	
	try
	{
		withSonarQubeEnv('sonarqube_7_5') {
        sh """ 
	    mvn -DBranch=${gitBranch} -Dsonar.branch=${gitBranch} -e -B sonar:sonar
	    sh """
        }
	}
	catch (Exception e) 
	{
		println "Failed to Run Sonar Analysis - ${currentBuild.fullDisplayName}"
		throw e
	}
	}
	}
	}
	stage('Quality Gate')
	{
	steps
	{
	script
	{	
	try
	{
		withSonarQubeEnv('sonarqube_7_5') {
        timeout(time: 1, unit: 'HOURS') {
        def qg = waitForQualityGate()
        if (qg.status != 'OK' && qg.status != 'WARN') {
            error "Pipeline aborted due to quality gate failure: ${qg.status}"
        }
        }
        }
	}
	catch (Exception e)
	{
		println "Failed to Test Quality Gate  - ${currentBuild.fullDisplayName}"
		throw e
	}
	}
	}
	}
	stage('Create Image Builder') {
      when {
        expression {
          openshift.withCluster() {
            return !openshift.selector("bc", "ccapp").exists();
          }
        }
      }
      steps {
        script {
          openshift.withCluster() {
            openshift.newBuild("--name=ccapp", "--image-stream=redhat-openjdk18-openshift:1.1", "--binary")
          }
        }
      }
    }
    stage('Build Image') {
      steps {
        script {
          openshift.withCluster() {
            openshift.selector("bc", "ccapp").startBuild("--from-file=target/Credit-Card-Processor-0.0.1-SNAPSHOT.jar", "--wait")
          }
        }
      }
    }
	stage('Push Image to Quay') {
	agent { label 'skopeo' }
      steps {
        script {
          openshift.withCluster() {
            sh "/usr/bin/skopeo copy docker://image-registry.openshift-image-registry.svc:5000/cicd/ccapp:latest \ docker://quay.apps.cluster-121b.sandbox1172.opentlc.com/quay/ccapp:latest \ --src-creds=kubeadmin:OVdMhKwaA1_QWJ7vkaiClCcKMQPof55QFTp-Znjm73c --dest-creds=quay:password --src-tls-verify=false \ --dest-tls-verify=false"
          }
        }
      }
    }
	stage('Vulnerability Scan') {
	agent { label 'skopeo' }
      steps {
        script {
          openshift.withCluster() {
        sh """
			QUAY_API_TOKEN="l7ipk8MHo09QutMyX59zth7rghi8PHDWYNIwN6PZ"
			QUAY_URL="https://quay.apps.cluster-121b.sandbox1172.opentlc.com"
			QUAY_REPO_NAME="quay/ccapp"
			echo -e "==> Get Image ID from Quay Enterprise for vulnerabilities scan ,Please wait..."
			curl -k -H "Authorization: Bearer ${QUAY_API_TOKEN}" ${QUAY_URL}/api/v1/repository/${QUAY_REPO_NAME}/image/ |jq -r '.images[].id' > /tmp/image_id.txt
			echo -e "==> This Image has So many Layers, See the below output"
			cat /tmp/image_id.txt
			echo -e "==> Scanning each layer for Critical Vulnerabilities, Please wait..."
			for A in "\$(cat /tmp/image_id.txt)"
				do
					echo -e "==> Scanning $A Layer, Please wait..."
					curl -k -H "Authorization: Bearer \${QUAY_API_TOKEN}" \${QUAY_URL}/api/v1/repository/quay/ccapp/image/\${A}/security?vulnerabilities=true |jq -r '.data.Layer.Features[].Vulnerabilities[] | .Name + " " + .NamespaceName + " " + .Severity' > /tmp/image-vulnerability.txt
				CRITICAL=\$(cat /tmp/image-vulnerability.txt | grep Critical | wc -l)
				if [ $CRITICAL -ne 0 ]; then
					echo -e "==> There are $CRITICAL Critical Vulnerabilities found in this Layer, Exiting from Pipeline..."
					exit 1
				else
					echo -e "==> No Critical Vulnerabilities found in this Layer"
				fi
			done
		sh """

          }
        }
      }
    }

}
}
